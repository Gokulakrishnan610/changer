<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conflict Detection Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>Conflict Detection Test</h1>
                <button id="testConflicts" class="btn btn-primary">Test Conflict Detection</button>
                <button id="reloadData" class="btn btn-secondary">Reload Data</button>
                
                <div class="mt-4">
                    <h3>Conflict Count: <span id="conflictCount">Loading...</span></h3>
                    <div id="conflictDetails" class="mt-3"></div>
                </div>
                
                <div class="mt-4">
                    <h3>Console Output:</h3>
                    <pre id="console" class="bg-light p-3" style="height: 300px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="user-state-manager.js"></script>
    <script src="performance-optimizer.js"></script>
    <script src="allocation_manager.js"></script>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        const logElement = document.getElementById('console');
        
        function addToConsole(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            logElement.textContent += `[${timestamp}] ${level}: ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('LOG', ...args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('WARN', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('ERROR', ...args);
        };
        
        let allocationManager = null;
        
        async function initializeTest() {
            try {
                console.log('üöÄ Initializing conflict detection test...');
                
                // Initialize allocation manager
                allocationManager = new AllocationManager();
                
                console.log('üìä Loading schedule data...');
                await allocationManager.loadScheduleData({
                    forceReload: true,
                    enableOptimization: false  // Disable optimization for debugging
                });
                
                console.log('‚úÖ Data loaded successfully');
                updateConflictDisplay();
                
            } catch (error) {
                console.error('‚ùå Error initializing test:', error);
            }
        }
        
        function updateConflictDisplay() {
            if (!allocationManager) return;
            
            const conflictCount = allocationManager.conflicts.length;
            document.getElementById('conflictCount').textContent = conflictCount;
            
            const detailsDiv = document.getElementById('conflictDetails');
            if (conflictCount === 0) {
                detailsDiv.innerHTML = '<div class="alert alert-success">No conflicts detected</div>';
            } else {
                let html = '<div class="alert alert-danger">Conflicts found:</div>';
                allocationManager.conflicts.slice(0, 10).forEach((conflict, index) => {
                    html += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6>${conflict.type}: ${conflict.message}</h6>
                                <small>Sessions: ${conflict.sessions.length}</small>
                            </div>
                        </div>
                    `;
                });
                if (allocationManager.conflicts.length > 10) {
                    html += `<div class="text-muted">... and ${allocationManager.conflicts.length - 10} more conflicts</div>`;
                }
                detailsDiv.innerHTML = html;
            }
        }
        
        document.getElementById('testConflicts').addEventListener('click', function() {
            if (allocationManager) {
                console.log('üîç Running conflict detection test...');
                allocationManager.detectAllConflicts();
                updateConflictDisplay();
                console.log(`‚úÖ Test complete - found ${allocationManager.conflicts.length} conflicts`);
            } else {
                console.warn('‚ö†Ô∏è Allocation manager not initialized');
            }
        });
        
        document.getElementById('reloadData').addEventListener('click', function() {
            initializeTest();
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeTest);
    </script>
</body>
</html> 