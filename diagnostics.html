<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Diagnostics - University Timetable Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .diagnostic-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .diagnostic-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .status-success {
            color: #28a745;
        }
        
        .status-warning {
            color: #ffc107;
        }
        
        .status-error {
            color: #dc3545;
        }
        
        .status-pending {
            color: #6c757d;
        }
        
        .test-result {
            padding: 0.5rem;
            border-radius: 5px;
            margin-top: 0.5rem;
        }
        
        .test-success {
            background-color: #d1f2eb;
            border: 1px solid #28a745;
        }
        
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
        }
        
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand">
                <i class="fas fa-stethoscope me-2"></i>
                System Diagnostics
            </span>
            <div class="navbar-nav ms-auto">
                <a href="allocation_manager.html" class="nav-link">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Allocation Manager
                </a>
                <a href="schedule_website.html" class="nav-link">
                    <i class="fas fa-calendar me-1"></i>
                    Schedule Viewer
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <h4><i class="fas fa-info-circle me-2"></i>System Diagnostics</h4>
                    <p>This page helps diagnose issues with the timetable system. It checks for file availability, data integrity, and system health.</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="diagnostic-card">
                    <div class="card-header">
                        <h5><i class="fas fa-file-alt me-2"></i>Data Files Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="fileTests">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="diagnostic-card">
                    <div class="card-header">
                        <h5><i class="fas fa-code me-2"></i>JavaScript Modules</h5>
                    </div>
                    <div class="card-body">
                        <div id="moduleTests">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="diagnostic-card">
                    <div class="card-header">
                        <h5><i class="fas fa-database me-2"></i>Data Integrity</h5>
                    </div>
                    <div class="card-body">
                        <div id="dataIntegrityTests">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="diagnostic-card">
                    <div class="card-header">
                        <h5><i class="fas fa-tachometer-alt me-2"></i>Performance Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="performanceTests">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-tools me-2"></i>System Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="runAllTests()">
                                    <i class="fas fa-play me-1"></i>
                                    Run All Tests
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-secondary w-100 mb-2" onclick="clearCache()">
                                    <i class="fas fa-trash me-1"></i>
                                    Clear Cache
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100 mb-2" onclick="downloadReport()">
                                    <i class="fas fa-download me-1"></i>
                                    Download Report
                                </button>
                            </div>
                            <div class="col-md-3">
                                <a href="allocation_manager.html" class="btn btn-success w-100 mb-2">
                                    <i class="fas fa-redo me-1"></i>
                                    Try Again
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal me-2"></i>Console Output</h5>
                    </div>
                    <div class="card-body">
                        <pre id="consoleOutput" style="height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 5px; font-size: 0.9rem;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let testResults = {};
        let consoleLog = [];

        // Custom console logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            consoleLog.push(logEntry);
            
            const consoleOutput = document.getElementById('consoleOutput');
            if (consoleOutput) {
                consoleOutput.textContent = consoleLog.join('\n');
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
            
            console.log(logEntry);
        }

        // File tests
        async function testDataFiles() {
            log('Testing data file availability...');
            const results = [];
            
            const files = [
                { path: './output/combined_lab_schedule.json', name: 'Lab Schedule Data' },
                { path: './output/combined_theory_schedule.json', name: 'Theory Schedule Data' },
                { path: './output/teacher_shift_dashboard_latest.json', name: 'Teacher Shift Data' },
                { path: './output/daily_campus_presence_latest.json', name: 'Daily Presence Data' }
            ];

            for (const file of files) {
                try {
                    log(`Checking ${file.name}...`);
                    const response = await fetch(file.path);
                    
                    if (response.ok) {
                        const data = await response.json();
                        results.push({
                            name: file.name,
                            status: 'success',
                            message: `✅ Available (${data.length || 'Unknown'} records)`,
                            details: `Size: ${(response.headers.get('content-length') || 'Unknown')} bytes`
                        });
                        log(`${file.name}: OK`);
                    } else {
                        results.push({
                            name: file.name,
                            status: 'error',
                            message: `❌ HTTP ${response.status}`,
                            details: response.statusText
                        });
                        log(`${file.name}: ERROR - HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    results.push({
                        name: file.name,
                        status: 'error',
                        message: `❌ ${error.message}`,
                        details: error.toString()
                    });
                    log(`${file.name}: ERROR - ${error.message}`, 'error');
                }
            }

            testResults.files = results;
            renderFileTests(results);
        }

        // Module tests
        async function testJavaScriptModules() {
            log('Testing JavaScript modules...');
            const results = [];

            const modules = [
                { name: 'UserStateManager', check: () => typeof userState !== 'undefined' },
                { name: 'PerformanceOptimizer', check: () => typeof performanceOptimizer !== 'undefined' },
                { name: 'AllocationManager', check: () => typeof AllocationManager !== 'undefined' },
                { name: 'Bootstrap', check: () => typeof bootstrap !== 'undefined' }
            ];

            modules.forEach(module => {
                try {
                    const available = module.check();
                    results.push({
                        name: module.name,
                        status: available ? 'success' : 'warning',
                        message: available ? '✅ Loaded' : '⚠️ Not available',
                        details: available ? 'Module is properly loaded' : 'Module may not be required or failed to load'
                    });
                    log(`${module.name}: ${available ? 'OK' : 'Missing'}`);
                } catch (error) {
                    results.push({
                        name: module.name,
                        status: 'error',
                        message: `❌ ${error.message}`,
                        details: error.toString()
                    });
                    log(`${module.name}: ERROR - ${error.message}`, 'error');
                }
            });

            testResults.modules = results;
            renderModuleTests(results);
        }

        // Data integrity tests
        async function testDataIntegrity() {
            log('Testing data integrity...');
            const results = [];

            try {
                // Test lab data
                const labResponse = await fetch('./output/combined_lab_schedule.json');
                if (labResponse.ok) {
                    const labData = await labResponse.json();
                    const validLab = Array.isArray(labData) && labData.length > 0;
                    results.push({
                        name: 'Lab Data Structure',
                        status: validLab ? 'success' : 'error',
                        message: validLab ? `✅ Valid (${labData.length} sessions)` : '❌ Invalid structure',
                        details: validLab ? 'Array with valid sessions' : 'Expected array of sessions'
                    });
                    log(`Lab data: ${validLab ? 'Valid' : 'Invalid'}`);
                }

                // Test theory data
                const theoryResponse = await fetch('./output/combined_theory_schedule.json');
                if (theoryResponse.ok) {
                    const theoryData = await theoryResponse.json();
                    const validTheory = Array.isArray(theoryData) && theoryData.length > 0;
                    results.push({
                        name: 'Theory Data Structure',
                        status: validTheory ? 'success' : 'error',
                        message: validTheory ? `✅ Valid (${theoryData.length} sessions)` : '❌ Invalid structure',
                        details: validTheory ? 'Array with valid sessions' : 'Expected array of sessions'
                    });
                    log(`Theory data: ${validTheory ? 'Valid' : 'Invalid'}`);
                }

            } catch (error) {
                results.push({
                    name: 'Data Integrity Check',
                    status: 'error',
                    message: `❌ ${error.message}`,
                    details: error.toString()
                });
                log(`Data integrity: ERROR - ${error.message}`, 'error');
            }

            testResults.dataIntegrity = results;
            renderDataIntegrityTests(results);
        }

        // Performance tests
        async function testPerformance() {
            log('Testing performance...');
            const results = [];

            // Test browser capabilities
            const browserTests = [
                { name: 'Local Storage', test: () => typeof Storage !== 'undefined' },
                { name: 'Fetch API', test: () => typeof fetch !== 'undefined' },
                { name: 'Promise Support', test: () => typeof Promise !== 'undefined' },
                { name: 'ES6 Support', test: () => { try { eval('const test = () => {}'); return true; } catch(e) { return false; } } }
            ];

            browserTests.forEach(test => {
                try {
                    const supported = test.test();
                    results.push({
                        name: test.name,
                        status: supported ? 'success' : 'error',
                        message: supported ? '✅ Supported' : '❌ Not supported',
                        details: supported ? 'Browser supports this feature' : 'Browser lacks this feature'
                    });
                    log(`${test.name}: ${supported ? 'Supported' : 'Not supported'}`);
                } catch (error) {
                    results.push({
                        name: test.name,
                        status: 'error',
                        message: `❌ Error testing`,
                        details: error.toString()
                    });
                    log(`${test.name}: ERROR - ${error.message}`, 'error');
                }
            });

            // Test memory usage if available
            if (performance.memory) {
                const memory = performance.memory;
                results.push({
                    name: 'Memory Usage',
                    status: 'success',
                    message: `✅ ${Math.round(memory.usedJSHeapSize / 1024 / 1024)}MB used`,
                    details: `Total: ${Math.round(memory.totalJSHeapSize / 1024 / 1024)}MB, Limit: ${Math.round(memory.jsHeapSizeLimit / 1024 / 1024)}MB`
                });
                log(`Memory: ${Math.round(memory.usedJSHeapSize / 1024 / 1024)}MB used`);
            }

            testResults.performance = results;
            renderPerformanceTests(results);
        }

        // Render functions
        function renderFileTests(results) {
            const container = document.getElementById('fileTests');
            container.innerHTML = results.map(result => `
                <div class="test-result test-${result.status}">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${result.name}</strong>
                        <span class="status-${result.status}">${result.message}</span>
                    </div>
                    <small class="text-muted">${result.details}</small>
                </div>
            `).join('');
        }

        function renderModuleTests(results) {
            const container = document.getElementById('moduleTests');
            container.innerHTML = results.map(result => `
                <div class="test-result test-${result.status}">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${result.name}</strong>
                        <span class="status-${result.status}">${result.message}</span>
                    </div>
                    <small class="text-muted">${result.details}</small>
                </div>
            `).join('');
        }

        function renderDataIntegrityTests(results) {
            const container = document.getElementById('dataIntegrityTests');
            container.innerHTML = results.map(result => `
                <div class="test-result test-${result.status}">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${result.name}</strong>
                        <span class="status-${result.status}">${result.message}</span>
                    </div>
                    <small class="text-muted">${result.details}</small>
                </div>
            `).join('');
        }

        function renderPerformanceTests(results) {
            const container = document.getElementById('performanceTests');
            container.innerHTML = results.map(result => `
                <div class="test-result test-${result.status}">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${result.name}</strong>
                        <span class="status-${result.status}">${result.message}</span>
                    </div>
                    <small class="text-muted">${result.details}</small>
                </div>
            `).join('');
        }

        // Utility functions
        async function runAllTests() {
            log('Starting comprehensive system diagnostics...');
            await testDataFiles();
            await testJavaScriptModules();
            await testDataIntegrity();
            await testPerformance();
            log('All tests completed');
        }

        function clearCache() {
            log('Clearing browser cache...');
            try {
                localStorage.clear();
                sessionStorage.clear();
                log('Cache cleared successfully');
                alert('Cache cleared! Try refreshing the allocation manager page.');
            } catch (error) {
                log(`Cache clear failed: ${error.message}`, 'error');
                alert('Failed to clear cache: ' + error.message);
            }
        }

        function downloadReport() {
            log('Generating diagnostic report...');
            const report = {
                timestamp: new Date().toISOString(),
                testResults: testResults,
                consoleLog: consoleLog,
                userAgent: navigator.userAgent,
                url: window.location.href
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-report-${new Date().toISOString().substr(0,19).replace(/:/g,'-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            log('Diagnostic report downloaded');
        }

        // Initialize diagnostics
        document.addEventListener('DOMContentLoaded', function() {
            log('System diagnostics initialized');
            runAllTests();
        });
    </script>
</body>
</html> 